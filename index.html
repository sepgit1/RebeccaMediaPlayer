<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebecca Media Player</title>
    
    <script>
        // Check if user is authenticated
        if (sessionStorage.getItem('musicPlayerAuthenticated') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Rebecca's elegant and futuristic media player with up to 500 songs and videos">
    <meta name="theme-color" content="#ff1493">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rebecca Media Player">
    <!-- iOS video inline playback (prevent fullscreen) -->
    <meta name="apple-mobile-web-app-status-bar" content="black">
    <!-- Cache bust: 2025-10-26-v5 -->
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" sizes="192x192" href="icons/icon-192x192.svg">
    <link rel="apple-touch-icon" href="icons/icon-192x192.svg">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css?v=2025-10-26-v5">
    
    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>
<body>
    <!-- Dynamic Animated Shapes Canvas - Behind player but on top of background -->
    <canvas id="dynamicShapesCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;"></canvas>
    
    <div class="container">
        <!-- ALWAYS VISIBLE: Install Instructions Banner -->
        <div id="installBanner" class="install-banner">
            <div class="banner-content">
                <span id="bannerText">ğŸ“± Tap the menu (â‹¯) â†’ "Add to home screen" to install this app</span>
                <button id="closeBannerBtn" class="close-banner-btn">âœ•</button>
            </div>
        </div>

        <header class="header">
            <div style="width:100%;display:flex;justify-content:center;align-items:center;margin-bottom:10px;">
                <img src="icons/banner.png" alt="Rebecca's Media Player Banner" style="max-width:1200px;width:100%;height:auto;border-radius:16px;box-shadow:0 2px 16px rgba(0,0,0,0.12);">
            </div>
            <div class="header-right">
                <div class="user-info">
                    <span id="userName">User</span>
                </div>
                <div class="song-counter">
                    <span id="songCount">0</span> / 500 items
                </div>
                <button id="installAppBtn" class="install-app-btn" title="Install App" style="display: none;">â¬‡ï¸ Install</button>
                <button id="modesBtn" class="modes-btn" title="Audio Modes">ğŸµ</button>
                <button id="settingsBtn" class="settings-btn" title="Settings">âš™ï¸</button>
            </div>
        </header>

        <!-- Scrollable Songs List -->
        <div class="songs-list-container">
            <h3 class="songs-list-title">ğŸ“‹ Playlist</h3>
            <ul id="playlistContainer" class="songs-list">
                <!-- Songs will be loaded here by JavaScript -->
            </ul>
        </div>

        <!-- Video Player (YouTube-style embedded box) -->
        <div id="videoContainer" class="video-container-box" style="display: none;">
            <div class="video-box-wrapper">
                <video id="videoPlayer" class="video-box-player" playsinline webkit-playsinline>
                    Your browser does not support the video tag.
                </video>
                <div class="video-box-controls">
                    <button id="expandVideoBtn" class="video-expand-btn" title="Expand video">â›¶ Expand</button>
                    <button id="closeVideoBtn" class="video-close-btn" title="Close video">âœ•</button>
                </div>
                <div class="video-time-display">
                    <span id="videoCurrentTime">0:00</span> / <span id="videoDuration">0:00</span>
                </div>
            </div>
        </div>

        <!-- Music Controls -->
        <div class="player-section">
            <div class="current-song">
                <div class="song-art">
                    <div class="music-note" id="mediaIcon">ğŸµ</div>
                </div>
                <div class="song-info">
                    <h2 id="currentSongTitle">No song selected</h2>
                    <p id="currentSongArtist">Select a song to start playing</p>
                </div>
            </div>

            <div class="controls">
                <button id="prevBtn" class="control-btn">â®ï¸</button>
                <button id="playPauseBtn" class="control-btn play-pause">â–¶ï¸</button>
                <button id="nextBtn" class="control-btn">â­ï¸</button>
                <button id="shuffleBtn" class="control-btn">ğŸ”€</button>
                <button id="repeatBtn" class="control-btn">ğŸ”</button>
                <button id="updateBtn" class="control-btn" title="Update App">ğŸ”„</button>
                <button id="ccBtn" class="control-btn" title="Closed Captions">CC</button>
            </div>

            <!-- Closed Captions Display -->
            <div id="ccDisplay" class="cc-display" style="display: none;">
                <div class="cc-text" id="ccText">Captions appear here...</div>
                <button id="closeCcBtn" class="close-cc-btn">âœ•</button>
            </div>

        </div>

        <!-- Comments Section -->
        <div class="comments-section">
            <h3>ğŸ’¬ Comments</h3>
            <div class="add-comment">
                <textarea id="commentInput" class="comment-input" placeholder="Share your thoughts about this song..."></textarea>
                <button id="postCommentBtn" class="post-comment-btn">ğŸ’¬ Post Comment</button>
            </div>
            <div id="commentsList" class="comments-list">
                <p class="no-comments">No comments yet. Be the first to comment!</p>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="upload-section" id="dropZone">
            <label for="fileInput" class="upload-btn">
                ğŸ“ Add Songs or Videos
                <input type="file" id="fileInput" accept="audio/*,video/*" multiple style="display: none;">
            </label>
            <p class="drop-hint">ğŸ’¡ Or drag & drop files here</p>
            <button id="clearAllBtn" class="clear-btn">ğŸ—‘ï¸ Clear All Songs</button>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state">
            <div class="empty-icon">ğŸ¶</div>
            <h3>Your playlist is empty!</h3>
            <p>Add some songs to get started</p>
        </div>
    </div>

    <!-- Audio Element -->
    <audio id="audioPlayer" preload="metadata"></audio>

    <!-- Install PWA Prompt -->
    <div id="installPrompt" class="install-prompt" style="display: none;">
        <div class="install-content">
            <h3>ğŸ“± Install Rebecca Media Player</h3>
            <p>Add this elegant app to your home screen for quick access!</p>
            <div class="install-buttons">
                <button id="installBtn" class="install-btn-yes">Install</button>
                <button id="dismissBtn" class="install-btn-no">Not now</button>
            </div>
        </div>
    </div>

    <!-- Safari/iPhone Install Instructions -->
    <div id="iosInstallGuide" class="ios-install-guide" style="display: none;">
        <div class="ios-guide-content">
            <h3>ğŸ“± Add to Home Screen (iPhone)</h3>
            <p><strong>Tap the Share button</strong> â¬†ï¸ at the bottom, then select <strong>"Add to Home Screen"</strong></p>
            <button id="closeIosGuide" class="ios-close-btn">âœ•</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal" style="display: none;">
        <div class="settings-modal-content">
            <div class="settings-header">
                <h2>âš™ï¸ Settings</h2>
                <button id="closeSettingsBtn" class="close-btn">âœ•</button>
            </div>
            
            <div class="settings-section">
                <label>ğŸŒ“ Theme</label>
                <div class="theme-options">
                    <button class="theme-btn" data-theme="dark" title="Dark Mode">ğŸŒ™</button>
                </div>
            </div>

            <div class="settings-section">
                <label>ğŸ¨ Color Family</label>
                <div class="color-families-buttons">
                    <button class="family-btn" data-family="maroon" title="Maroon Family">ğŸ”´ Maroon</button>
                    <button class="family-btn" data-family="cyan" title="Cyan Family">ğŸ”µ Cyan</button>
                    <button class="family-btn" data-family="forest" title="Forest Family">ğŸŸ¢ Forest</button>
                </div>
            </div>

            <div class="settings-section">
                <label>ğŸµ Other Options</label>
                <div class="toggle-option">
                    <span>Enable Animations</span>
                    <input type="checkbox" id="animationsToggle" class="toggle-checkbox">
                </div>
                <button id="updateSettingsBtn" class="update-btn">âœ“ Update Settings</button>
            </div>

            <!-- Privacy & Safety Section -->
            <div class="settings-section privacy-section">
                <label>ğŸ”’ Privacy & Safety</label>
                <div class="privacy-info">
                    <p><strong>Rebecca's Safety is Our Priority</strong></p>
                    <ul>
                        <li>âœ… No location tracking or GPS</li>
                        <li>âœ… No personal data collection</li>
                        <li>âœ… No geolocation services</li>
                        <li>âœ… All data stays on this device</li>
                        <li>âœ… No third-party tracking</li>
                        <li>âœ… Completely private & secure</li>
                    </ul>
                </div>
            </div>

            <!-- Admin Panel (Hidden by default) -->
            <div id="adminPanel" class="admin-panel" style="display: none;">
                <div class="admin-divider"></div>
                <div class="admin-header">
                    <h3>ğŸ‘‘ Admin Controls</h3>
                </div>
                

                <div class="admin-divider"></div>
                    <h3>ğŸ‘‘ Admin Controls</h3>
                </div>
                
                <div class="settings-section">
                    <label>ğŸ“Š App Management</label>
                    <div class="admin-buttons">
                        <button id="clearCacheBtn" class="admin-btn">ğŸ§¹ Clear Cache</button>
                        <button id="resetAppBtn" class="admin-btn danger">âš ï¸ Reset App</button>
                    </div>
                </div>

                <div class="settings-section">
                    <label>ï¿½ Live Storage</label>
                    <div class="storage-info">
                        <p>Songs: <span id="adminSongCount">0</span></p>
                        <p>Storage Used: <span id="adminStorageSize">0 MB</span></p>
                    </div>
                </div>

                <div class="settings-section">
                    <label>ï¿½ğŸ”„ App Version</label>
                    <p class="version-info">v1.0.0 - Updated 2025-10-26</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Modes Modal -->
    <div id="modesModal" class="settings-modal" style="display: none;">
        <div class="settings-modal-content">
            <div class="settings-header">
                <h2>ğŸµ Audio Modes</h2>
                <button id="closeModesBtn" class="close-btn">âœ•</button>
            </div>
            
            <div class="settings-section">
                <label>Select Audio Mode</label>
                <div class="modes-grid">
                    <button class="mode-btn" data-mode="treble" title="Treble - Enhanced high frequencies">
                        <span class="mode-icon">ğŸ¸</span>
                        <span class="mode-name">Treble</span>
                    </button>
                    <button class="mode-btn" data-mode="bass" title="Bass - Enhanced low frequencies">
                        <span class="mode-icon">ğŸ¥</span>
                        <span class="mode-name">Bass</span>
                    </button>
                    <button class="mode-btn" data-mode="earphones" title="Earphones - Optimized for earbuds">
                        <span class="mode-icon">ğŸ§</span>
                        <span class="mode-name">Earphones</span>
                    </button>
                    <button class="mode-btn" data-mode="tv" title="TV - Optimized for speakers">
                        <span class="mode-icon">ğŸ“º</span>
                        <span class="mode-name">TV</span>
                    </button>
                    <button class="mode-btn" data-mode="carradio" title="Car Radio - Optimized for car audio">
                        <span class="mode-icon">ğŸš—</span>
                        <span class="mode-name">Car Radio</span>
                    </button>
                    <button class="mode-btn" data-mode="bluetooth" title="Bluetooth - Optimized for wireless speakers">
                        <span class="mode-icon">ğŸ”µ</span>
                        <span class="mode-name">Bluetooth</span>
                    </button>
                </div>
            </div>

            <div class="settings-section">
                <p id="currentModeDisplay" class="current-mode-text">Current Mode: <strong>Normal</strong></p>
            </div>
        </div>
    </div>

    <!-- Google Drive API Setup -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <!-- Google Drive Sync Module -->
    <script>
        // Google Drive Configuration
        const GOOGLE_DRIVE_CONFIG = {
            CLIENT_ID: '285585477421-hbsulrv5gtpf1pohmgfes9vkl8loaeij.apps.googleusercontent.com',
            API_KEY: 'AIzaSyAMWtB8sAX6TCBJ048B18Jkb-_RLJO5c2g',
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        };

        class GoogleDriveSync {
            constructor() {
                this.tokenClient = null;
                this.accessToken = null;
                this.isAuthenticated = false;
                this.folderId = null;
            }

            async initializeGoogleAPI() {
                return gapi.client.init({
                    apiKey: GOOGLE_DRIVE_CONFIG.API_KEY,
                    discoveryDocs: GOOGLE_DRIVE_CONFIG.DISCOVERY_DOCS
                });
            }

            async authenticateWithGoogle() {
                try {
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
                        scope: GOOGLE_DRIVE_CONFIG.SCOPES,
                        callback: (response) => this.handleAuthResponse(response)
                    });

                    const storedToken = localStorage.getItem('google_access_token');
                    if (storedToken) {
                        this.accessToken = storedToken;
                        this.isAuthenticated = true;
                        return true;
                    }

                    this.tokenClient.requestAccessToken();
                    return new Promise((resolve) => {
                        this.authCallback = resolve;
                    });
                } catch (error) {
                    console.error('Google authentication error:', error);
                    return false;
                }
            }

            handleAuthResponse(response) {
                if (response.access_token) {
                    this.accessToken = response.access_token;
                    this.isAuthenticated = true;
                    localStorage.setItem('google_access_token', response.access_token);
                    if (this.authCallback) this.authCallback(true);
                }
            }

            async createOrGetBeccaFolder() {
                try {
                    if (this.folderId) return this.folderId;

                    const response = await gapi.client.drive.files.list({
                        q: "name='Becca Music Player' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                        spaces: 'drive',
                        fields: 'files(id, name)',
                        pageSize: 1
                    });

                    if (response.result.files && response.result.files.length > 0) {
                        this.folderId = response.result.files[0].id;
                        return this.folderId;
                    }

                    const createResponse = await gapi.client.drive.files.create({
                        resource: {
                            name: 'Becca Music Player',
                            mimeType: 'application/vnd.google-apps.folder'
                        },
                        fields: 'id'
                    });

                    this.folderId = createResponse.result.id;
                    return this.folderId;
                } catch (error) {
                    console.error('Error creating/getting Becca folder:', error);
                    throw error;
                }
            }

            async savePlaylistToGoogleDrive(playlist) {
                try {
                    const folderId = await this.createOrGetBeccaFolder();
                    const fileContent = JSON.stringify(playlist, null, 2);
                    
                    const response = await gapi.client.drive.files.list({
                        q: `name='becca_playlists.json' and '${folderId}' in parents and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id)',
                        pageSize: 1
                    });

                    const metadata = {
                        name: 'becca_playlists.json',
                        mimeType: 'application/json',
                        parents: [folderId]
                    };

                    if (response.result.files && response.result.files.length > 0) {
                        await gapi.client.drive.files.update({
                            fileId: response.result.files[0].id,
                            resource: metadata,
                            media: { body: fileContent },
                            fields: 'id'
                        });
                    } else {
                        await gapi.client.drive.files.create({
                            resource: metadata,
                            media: { body: fileContent },
                            fields: 'id'
                        });
                    }

                    return true;
                } catch (error) {
                    console.error('Error saving playlist:', error);
                    throw error;
                }
            }

            async loadPlaylistFromGoogleDrive() {
                try {
                    const folderId = await this.createOrGetBeccaFolder();
                    const response = await gapi.client.drive.files.list({
                        q: `name='becca_playlists.json' and '${folderId}' in parents and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id)',
                        pageSize: 1
                    });

                    if (!response.result.files || response.result.files.length === 0) {
                        return null;
                    }

                    const fileId = response.result.files[0].id;
                    const fileResponse = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });

                    return fileResponse.result;
                } catch (error) {
                    console.error('Error loading playlist:', error);
                    throw error;
                }
            }

            async saveCommentsToGoogleDrive(comments) {
                try {
                    const folderId = await this.createOrGetBeccaFolder();
                    const fileContent = JSON.stringify(comments, null, 2);
                    
                    const response = await gapi.client.drive.files.list({
                        q: `name='becca_comments.json' and '${folderId}' in parents and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id)',
                        pageSize: 1
                    });

                    const metadata = {
                        name: 'becca_comments.json',
                        mimeType: 'application/json',
                        parents: [folderId]
                    };

                    if (response.result.files && response.result.files.length > 0) {
                        await gapi.client.drive.files.update({
                            fileId: response.result.files[0].id,
                            resource: metadata,
                            media: { body: fileContent },
                            fields: 'id'
                        });
                    } else {
                        await gapi.client.drive.files.create({
                            resource: metadata,
                            media: { body: fileContent },
                            fields: 'id'
                        });
                    }

                    return true;
                } catch (error) {
                    console.error('Error saving comments:', error);
                    throw error;
                }
            }

            async loadCommentsFromGoogleDrive() {
                try {
                    const folderId = await this.createOrGetBeccaFolder();
                    const response = await gapi.client.drive.files.list({
                        q: `name='becca_comments.json' and '${folderId}' in parents and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id)',
                        pageSize: 1
                    });

                    if (!response.result.files || response.result.files.length === 0) {
                        return null;
                    }

                    const fileId = response.result.files[0].id;
                    const fileResponse = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });

                    return fileResponse.result;
                } catch (error) {
                    console.error('Error loading comments:', error);
                    throw error;
                }
            }

            async syncAllData(playlist, comments) {
                try {
                    await Promise.all([
                        this.savePlaylistToGoogleDrive(playlist),
                        this.saveCommentsToGoogleDrive(comments)
                    ]);
                    return true;
                } catch (error) {
                    console.error('Error syncing data:', error);
                    throw error;
                }
            }

            async loadAllData() {
                try {
                    const [playlist, comments] = await Promise.all([
                        this.loadPlaylistFromGoogleDrive(),
                        this.loadCommentsFromGoogleDrive()
                    ]);
                    return { playlist, comments };
                } catch (error) {
                    console.error('Error loading data:', error);
                    throw error;
                }
            }

            logout() {
                this.accessToken = null;
                this.isAuthenticated = false;
                this.folderId = null;
                localStorage.removeItem('google_access_token');
            }
        }

        // Initialize Google Drive Sync instance
        const googleDriveSync = new GoogleDriveSync();
    </script>

    <!-- Register Service Worker for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(registration => {
                console.log('Service Worker registered successfully:', registration);
            }).catch(error => {
                console.log('Service Worker registration failed:', error);
            });
        }
    </script>

    <!-- Scripts -->
    <script src="script.js?v=2025-10-26-v5"></script>
</body>
</html>